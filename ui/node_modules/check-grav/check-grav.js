var url = require('url');
var http = require('http');
module.exports = {
  gravatar_exist: function(email_hash, exist){
    var req_options = {};
    
    if(process.env.http_proxy === undefined){
      req_options = {
          host: 'http://gravatar.com',
          port: 80,
          path: '/avatar/' + email_hash + '.png?d=404',
          method: 'HEAD',
      };
    }else{
      var url_req = 'http://gravatar.com/avatar/' + email_hash + '.png?d=404';
      var proxy_url = url.parse(process.env.http_proxy);
      req_options = {
          host: proxy_url.hostname,
          port: proxy_url.port,
          path: url_req,
          method: 'HEAD',
      };
    }
    
    var head_req = http.request(req_options, function(res) {
        if(res.statusCode == 404){
          exist(false);
        }else if(res.statusCode == 200){
          exist(true);
        }else{
          exist(false);
        }
    });
    
    head_req.on('socket', function (socket) {
      socket.setTimeout(3000);
      socket.on('timeout', function() {
          head_req.abort();
      });
    });
    
    head_req.on('error', function (e) {
      console.error('Unable to verify if the gravatar account exist: '+e.message)
      exist(false);
    });
    
    head_req.end();
  }
}